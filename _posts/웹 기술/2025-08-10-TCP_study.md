---
layout: post
title: "TCP 공부"
date: 2025-08-10 17:00:00 +0900
categories: [웹 기술]
---

### 1. 개요

TCP 핸드셰이크는 신뢰성 있는 통신을 위해 연결을 설정하고 해제하는 절차를 정의한 과정이다.

TCP는 신뢰성 있는 데이터 전송을 보장하는 프로토콜이며 이 신뢰성을 확보하기 위한 절차가 바로 Handshake 과정이다. **`3-way Handshake`**는 통신을 시작하기 전에 클라이언트와 서버가 서로 통신할 준비가 되었는지 확인하는 과정이며 **`4-way Handshake`**는 통신을 정상적으로 종료하기 위해 서로의 의사를 확인하는 절차이다. 이 과정은 모든 TCP 기반 통신에 적용된다.

### 2. 동작 원리

#### **3-way Handshake (연결 수립)**
클라이언트와 서버는 총 3번의 패킷을 주고받으며 연결을 설정한다.
![3-way Handshake](/assets/images/Tcp_1.png)

1.  **[Client → Server] SYN (Synchronize)**
    *   클라이언트가 서버에 접속을 요청하며 `SYN` 패킷을 보낸다. 이때 통신에 사용할 임의의 시퀀스 번호(예: `seq=x`)를 함께 보낸다.
2.  **[Server → Client] SYN + ACK (Acknowledge)**
    *   서버는 클라이언트의 요청을 받고 통신을 수락한다는 의미로 `SYN`과 `ACK`를 함께 보낸다.
    *   `ACK`에는 클라이언트가 보낸 시퀀스 번호에 1을 더한 값(`ack=x+1`)을 담아 "당신의 요청을 잘 받았다"고 응답한다.
    *   `SYN`에는 서버가 사용할 임의의 시퀀스 번호(예: `seq=y`)를 담아 보낸다.
3.  **[Client → Server] ACK**
    *   클라이언트는 서버의 응답을 받고 서버가 보낸 시퀀스 번호에 1을 더한 값(`ack=y+1`)을 `ACK`에 담아 보낸다.
    *   이 패킷을 받은 서버는 연결이 완전히 수립되었다고 판단하고 데이터 통신을 시작한다.

#### **4-way Handshake (연결 종료)**
연결 종료는 총 4번의 패킷을 주고받으며 이루어진다.
![4-way Handshake](/assets/images/Tcp_2.png)

1.  **[Client → Server] FIN (Finish)**
    *   클라이언트가 서버에 연결을 종료하고 싶다는 의사를 `FIN` 패킷에 담아 보낸다.
2.  **[Server → Client] ACK**
    *   서버는 클라이언트의 종료 요청을 받았다는 의미로 `ACK`를 보낸다. 이 상태에서 서버는 아직 보낼 데이터가 남아있다면 마저 전송할 수 있다.
3.  **[Server → Client] FIN**
    *   서버가 모든 데이터 전송을 마치고 연결을 종료할 준비가 되면 클라이언트에게 `FIN` 패킷을 보낸다.
4.  **[Client → Server] ACK**
    *   클라이언트는 서버의 종료 요청을 받았다는 `ACK`를 보낸다. 이 패킷을 받은 서버는 연결을 완전히 종료한다. 클라이언트는 일정 시간(TIME_WAIT) 동안 대기한 후 접속을 최종적으로 닫는다.

### 3. 보안 관점에서의 의미

*   **SYN Flooding (DoS 공격):**
    공격자는 3-way Handshake의 1단계인 `SYN` 패킷만 대량으로 보내고 마지막 `ACK`를 보내지 않아 서버가 수많은 연결을 미완성 상태(Half-Open)로 유지하게 만든다. 이로 인해 서버의 연결 자원이 고갈되어 정상적인 사용자의 접속을 막는 서비스 거부(DoS) 공격이 발생한다.

*   **Nmap 스캔 원리:**
    *   **TCP Connect Scan (`-sT`):** Nmap은 완전한 3-way Handshake를 수행하여 연결을 수립한다. 연결이 성공하면 포트가 열린 것(Open)으로 판단한다. 이 방식은 로그에 명확한 기록을 남긴다.
    *   **SYN Scan (`-sS`, Stealth Scan):** Nmap은 `SYN` 패킷만 보내고 서버로부터 `SYN+ACK` 응답을 받으면 포트가 열렸다고 판단한 뒤, 마지막 `ACK`를 보내지 않고 `RST`(Reset)를 보내 연결을 끊는다. Handshake를 완료하지 않으므로 로그에 잘 남지 않아 더 은밀한 스캔이 가능하다.

<hr class="short-rule">





### 시각 자료(이미지) 제작을 위한 스크립트

#### **Wireshark를 이용한 Handshake 과정 캡처 이미지 제작**

1.  Wireshark를 실행하고 네트워크 인터페이스 캡처를 시작합니다.
2.  터미널이나 브라우저를 이용해 특정 서버(예: `nmap.org`)에 접속하는 간단한 TCP 통신을 유발합니다. (예: `curl http://nmap.org`)
3.  Wireshark에서 캡처를 중지합니다.
4.  상단 디스플레이 필터 창에 `tcp.flags.syn==1 || tcp.flags.fin==1` 을 입력하여 Handshake 관련 패킷만 필터링합니다.
5.  **이미지 1 (3-way Handshake):**
    *   패킷 목록에서 `SYN`, `SYN, ACK`, `ACK` 순서로 나타나는 세 개의 패킷을 찾습니다.
    *   이 세 개의 패킷이 모두 보이도록 화면을 구성하고 스크린샷을 찍습니다.
    *   이미지 편집기에서 각 패킷 옆에 `1. SYN`, `2. SYN+ACK`, `3. ACK`와 같이 번호를 매기고 흐름을 화살표로 표시하여 저장합니다.
6.  **이미지 2 (4-way Handshake):**
    *   통신이 끝나는 부분에서 `FIN, ACK`, `ACK`, `FIN, ACK`, `ACK` 순서로 나타나는 네 개의 패킷을 찾습니다.
    *   이 네 개의 패킷이 보이도록 화면을 구성하고 스크린샷을 찍습니다.
    *   이미지 편집기에서 각 패킷 옆에 `1. FIN`, `2. ACK`, `3. FIN`, `4. ACK` 와 같이 번호를 매기고 흐름을 화살표로 표시하여 저장합니다.