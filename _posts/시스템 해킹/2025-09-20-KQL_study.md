---
layout: post
title: "KQL 공부"
date: 2025-09-20 17:00:00 +0900
categories: [시스템 해킹]
---

### 1. 개요

KQL은 Microsoft Azure 환경의 방대한 로그 데이터에서 특정 정보를 검색하고 분석하기 위한 쿼리 언어이다.

Azure Sentinel(SIEM), Azure Monitor 등에서 수집된 로그(CCTV 영상)를 분석하여 침해 흔적을 찾는 데이터 분석 기술이다.

---

### 2. 기본 구조 (파이프라이닝)

KQL의 가장 큰 특징은 파이프(`|`)를 이용한 데이터 처리이다. 테이블 이름으로 시작하여 파이프를 통해 여러 연산자를 체인처럼 연결하여 원하는 결과를 단계적으로 필터링하고 가공한다.

`[테이블 이름] | [연산자 1] | [연산자 2] | ...`

---

### 3. 주요 연산자 (Operators)

*   **`where`**: 특정 조건을 만족하는 행만 필터링한다. (SQL의 `WHERE`와 유사)
*   **`project`**: 결과에 표시할 열을 선택한다. (SQL의 `SELECT`와 유사)
*   **`summarize`**: 데이터를 그룹화하고 집계(개수 세기, 평균 계산 등)한다. (SQL의 `GROUP BY`와 유사)
*   **`take` / `limit`**: 지정된 수만큼의 행을 임의로 가져온다. (데이터 샘플링에 유용)
*   **`order by`**: 지정된 열을 기준으로 결과를 정렬한다.

---

### 4. 사용 예시: 실패한 로그인 시도 찾기

Azure AD(Entra ID)의 로그인 로그(`SigninLogs`)에서 실패한(성공이 아닌) 로그인 기록을 찾아 시간, 사용자, IP 주소, 위치 정보를 최신순으로 10개만 출력하는 쿼리이다.

```kql
SigninLogs
| where ResultType != 0  // ResultType 0이 성공을 의미
| order by TimeGenerated desc
| take 10
| project TimeGenerated, UserPrincipalName, AppDisplayName, IPAddress, Location
```

---

### 5. 보안 관점에서의 의미

KQL은 클라우드 환경의 보안 분석가에게 필수적인 기술이다.

*   **위협 헌팅 (Threat Hunting):**
    '특정 IP에서 평소와 다른 지역에서의 로그인이 있었는가?' 와 같이 가설을 세우고, KQL을 이용해 로그를 분석하여 잠재적인 위협(IoC, Indicator of Compromise)을 능동적으로 찾아낼 수 있다.

*   **침해 사고 대응 (Incident Response):**
    보안 사고 발생 시, KQL을 이용해 공격자의 침투 경로, 영향받은 시스템, 유출된 데이터 등을 로그 기반으로 추적하여 피해 범위를 파악하고 대응 전략을 수립할 수 있다.

<hr class="short-rule">
